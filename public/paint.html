<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link href="https://fonts.googleapis.com/css?family=Paytone+One|Source+Sans+Pro:300,700" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="/public/stylesheets/style2.css" rel="stylesheet">
	<title>●○●CHAT ROOM●○●</title>

	<!--
		<script id=io type="text/javascript" src="">
			var hostname = location.hostname;
			var path = path.join(hostname, 'socket.io', 'socket.io.js');
			document.getElementById("io").src = path;
		</script>
	-->
	<script src="../socket.io/socket.io.js"></script>
	<script>
	/*
		var hostname = location.hostname;
		var socket = io();
		emit = function (name, data) {
			// json → 文字列に変換して送信する関数
			socket.emit(name, JSON.stringify(data));
		};

		window.onload = function () {
			//chat
			//			var form = document.getElementById("textarea");
			let msg = document.getElementById("chatarea");
			let msgList = document.getElementById("msgList");
			let send = document.getElementById("send");
			let popupBtn = document.getElementById("popup_btn");
			let popup = document.getElementById("popup");

			/*
				send.onclick = function() {
			//		var msgjson = JSON.stringify(msg.value());
					socket.emit("chat message", msg.value);
					msg.value("");
				};
				*/
				/*
			let user = window.prompt("ユーザー名を入力してください", "");
			let mySocketId;
			//if(user == NULL) location.href="/public/inde.html";
			socket.emit("username", user);//動作確認してない

			socket.on("connect", () => {
				socket.on("userlist", userlist => {
					let peoplelist = userlist;
				});
				socket.on("socketid notice", id => {
					mySocketId = id;
				});
			})

			send.addEventListener("click", e => {
				if(msg.value != ""){
					socket.emit("chat message", msg.value);
					console.log({ text: msg.value });
					console.log(msg.value);
					msg.value = "";
				}
			});

			msg.addEventListener("keypress", e => {
				if(e.keyCode == "13"){
					if(msg.value != ""){
						socket.emit("chat message", msg.value);
						console.log({text: msg.value});
						console.log(msg.value);
						msg.value = "";
					}
				}
			});

			socket.on("chat message", data => {
				let li = document.createElement('li');// liタグ作成
				li.innerText = data; // liタグに値を入れる
				msgList.appendChild(li); // ulタグの子ノードとして作成したliタグを追加
			});

			socket.on("username", name => {
				let liname = document.createElement('li');
				liname.innerText = name + 'さんが入室しました';
				msgList.appendChild(liname);
			});

			socket.on("exit user", name => {
				let liexit = document.createElement('li');
				liexit.innerText = name + 'さんが退室しました';
				msgList.appendChild(liexit);
			})

			//chatここまで
		};
		*/
	</script>
</head>

<body>
	<div class="site">

		<p>ILLAST SPACE</p>

	</div>
	<!--		<button type="button" name="popup_btn">Input your name</button>-->
	<div id=layer class=layer>
		<canvas id="canvas1" width="600" height="600"></canvas>
		<canvas id="canvas2" width="600" height="600"></canvas>
		<canvas id="canvas3" width="600" height="600"></canvas>
		<canvas id="canvas4" width="600" height="600"></canvas>
		<canvas id="canvas5" width="600" height="600"></canvas>
		<canvas id="canvas6" width="600" height="600"></canvas>
		<canvas id="canvas7" width="600" height="600"></canvas>
		<canvas id="canvas8" width="600" height="600"></canvas>
		<canvas id="canvas9" width="600" height="600"></canvas>
		<canvas id="canvas10" width="600" height="600"></canvas>
	</div>
	<script src="jscolor.js"></script>
	<div class="colors">

		<button onclick="document.getElementById('foo').jscolor.show()">
			Show Picker</button>

		<button onclick="document.getElementById('foo').jscolor.hide()">
			Hide Picker</button>

		<p>
			<input id="foo" class="jscolor {onFineChange:'update(this)'}" value="cc4499">
			</input>
			<input id="n_layer" type="number" max=10 min=1 value=1></input>
			<button id="reset" type="button">リセット</button>
			<button id="eraser" type="button">消しゴム</button>

	<p>線の太さ
		<input type="range" min="1" max="50" value="10" id="lineWidth">
		<span id="lineNum">10</span>
	</p>
	<div id="sum">
		<canvas id="s_canvas1" width="600" height="600"></canvas>
		<canvas id="s_canvas2" width="600" height="600"></canvas>
		<canvas id="s_canvas3" width="600" height="600"></canvas>
		<canvas id="s_canvas4" width="600" height="600"></canvas>
		<canvas id="s_canvas5" width="600" height="600"></canvas>
		<canvas id="s_canvas6" width="600" height="600"></canvas>
		<canvas id="s_canvas7" width="600" height="600"></canvas>
		<canvas id="s_canvas8" width="600" height="600"></canvas>
		<canvas id="s_canvas9" width="600" height="600"></canvas>
		<canvas id="s_canvas10" width="600" height="600"></canvas>
	</div>
	</div>
	<div id="chat">
		<input type="text" id="chatarea" placeholder="CHAT AREA"></input>
		<button id="send" type="button">SEND</button>
		<div id="log">
			<ul id="msgList"></ul>
		</div>
	</div>

	<script>
	//chat
	var hostname = location.hostname;
	var socket = io();
	emit = function (name, data) {
		// json → 文字列に変換して送信する関数
		socket.emit(name, JSON.stringify(data));
	};

	window.onload = function () {
		//chat
		//			var form = document.getElementById("textarea");
		let msg = document.getElementById("chatarea");
		let msgList = document.getElementById("msgList");
		let send = document.getElementById("send");
		let popupBtn = document.getElementById("popup_btn");
		let popup = document.getElementById("popup");

		/*
			send.onclick = function() {
		//		var msgjson = JSON.stringify(msg.value());
				socket.emit("chat message", msg.value);
				msg.value("");
			};
			*/
		let user = window.prompt("ユーザー名を入力してください", "");
		let mySocketId;
		//if(user == NULL) location.href="/public/inde.html";
		socket.emit("username", user);//動作確認してない

		socket.on("connect", () => {
			socket.on("userlist", userlist => {
				let peoplelist = userlist;
			});
			socket.on("socketid notice", id => {
				mySocketId = id;
				console.log(mySocketId);
			});
		})

		send.addEventListener("click", e => {
			if(msg.value != ""){
				socket.emit("chat message", msg.value);
				console.log({ text: msg.value });
				console.log(msg.value);
				msg.value = "";
			}
		});

		msg.addEventListener("keypress", e => {
			if(e.keyCode == "13"){
				if(msg.value != ""){
					socket.emit("chat message", msg.value);
					console.log({text: msg.value});
					console.log(msg.value);
					msg.value = "";
				}
			}
		});

		socket.on("chat message", data => {
			let li = document.createElement('li');// liタグ作成
			li.innerText = data; // liタグに値を入れる
			msgList.appendChild(li); // ulタグの子ノードとして作成したliタグを追加
		});

		socket.on("layer changed", layerlst => {
			layer_used = layerlst;
		});

		socket.on("layer notice", layernum => {
			n_layer.value = layernum + 1;
		})

		socket.on("username", name => {
			let liname = document.createElement('li');
			liname.innerText = name + 'さんが入室しました';
			msgList.appendChild(liname);
		});

		socket.on("exit user", name => {
			let liexit = document.createElement('li');
			liexit.innerText = name + 'さんが退室しました';
			msgList.appendChild(liexit);
		})



	};
	//chatここまで

		let layers = [document.getElementById("canvas1"), document.getElementById("canvas2"), document.getElementById("canvas3"), document.getElementById("canvas4"), document.getElementById("canvas5"), document.getElementById("canvas6"), document.getElementById("canvas7"), document.getElementById("canvas8"), document.getElementById("canvas9"), document.getElementById("canvas10")];
		let s_layers = [document.getElementById("s_canvas1"), document.getElementById("s_canvas2"), document.getElementById("s_canvas3"), document.getElementById("s_canvas4"), document.getElementById("s_canvas5"), document.getElementById("s_canvas6"), document.getElementById("s_canvas7"), document.getElementById("s_canvas8"), document.getElementById("s_canvas9"), document.getElementById("s_canvas10")];
		let canvas = layers[0];
		let ctx = layers[0].getContext("2d");
		canvas.style.display = "inline";
		canvas.style.zIndex = "10";
		let layer = document.getElementById("layer");
		let reset = document.getElementById("reset");
		let eraser = document.getElementById("eraser");
		let n_layer = document.getElementById("n_layer");

		let pixel_data = [];
		let bef_pix;
		let af_pix;

		let mouseX, mouseY;
		let draw_f = false;
		let multi = false;
		let reset_f = false;
		let buffx = [];
		let buffy = [];
		let layer_used = new Array(10);
		let last = 0;
		let _last = 0;
		let last_undo = -1;
		let alpha = 0;
		let r = 0;
		let g = 0;
		let b = 0;
		let undoImage = [];
		let pen = true;
		let esc = 0;

		function update(picker) {
			r = Math.round(picker.rgb[0]);
			g = Math.round(picker.rgb[1]);
			b = Math.round(picker.rgb[2]);
		}
		reset.addEventListener("pointerdown", function (e) {
			f_reset = true;
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			setTimeout("get_pix()", 200);
		});

		eraser.addEventListener("pointerdown", function (e) {
			if (pen) {
				e.target.innerHTML = "ペン";
			} else {
				e.target.innerHTML = "消しゴム";
			}
			pen = !pen;
		});

		n_layer.addEventListener("change", function (e) {
			// canvas.style.display = "none";
			// canvas.style.zIndex = "0";
			//layer番号送信
			if (Number(e.target.value) >= 1 && Number(e.target.value) <= 10) {
				if(!layer_used[Number(e.target.value)-1]) {
					socket.emit("layer changed", Number(e.target.value)-1);
					canvas.style.display = "none";
					canvas.style.zIndex = "0";
					canvas = layers[Number(e.target.value) - 1];
					ctx = canvas.getContext("2d");
					canvas.style.display = "inline";
					canvas.style.zIndex = "10";
				} else {
					n_layer.value = mySocketId;
				}
/*
				console.log(Number(e.target.value));
				canvas.style.display = "none";
				canvas.style.zIndex = "0";
				let layernum = Number(e.target.value);
				if (!layer_used[layernum]) {
					console.log(layer_used[layernum]);
					socket.emit("layer changed", layernum);
					console.log(layer_used[layernum]);
					canvas = layer[layernum];
					ctx = canvas.getContext("2d");
					// canvas.style.display = "inline";
					// canvas.style.zIndex = "10";
				} else {
					e.target.value = layer_used.indexOf(mySocketId);
				}
				canvas.style.display = "inline";
				canvas.style.zIndex = "10";

				canvas.style.display = "none";
				canvas.style.zIndex = "0";
//				canvas = layers[Number(e.target.value) - 1];
//				ctx = canvas.getContext("2d");
				canvas.style.display = "inline";
				canvas.style.zIndex = "10";
				*/
				console.log(canvas.style);
			}
		});


		layer.addEventListener("pointermove", function (e) {
			var rect = e.target.getBoundingClientRect();
			ctx.lineWidth = document.getElementById("lineWidth").value;
			mouseX = e.clientX - rect.left;
			mouseY = e.clientY - rect.top;
			if (e.pointerType === "pen") {
				alpha = e.pressure;
				ctx.lineWidth = document.getElementById("lineWidth").value * e.pressure;
			} else {
				alpha = 0.5;
			}
			if (draw_f === true) {
				draw(e);
			}
		});

		function draw(e) {
			if (Math.sqrt(Math.pow(buffx[last - 1] - mouseX, 2) + Math.pow(buffy[last - 1] - mouseY, 2)) > 5) {
				buffx.push(mouseX);
				buffy.push(mouseY);

				if (pen) {
					ctx.strokeStyle = "rgba(0,0,0,0)";
					ctx.fillStyle = "rgba(" + [r, g, b, alpha] + ")";
					ctx.globalCompositeOperation = 'source-over';
				} else {
					ctx.strokeStyle = "rgba(255,255,255,1)";
					ctx.globalCompositeOperation = 'destination-out';
				}
				if (last > 1 && Math.sqrt(Math.pow(buffx[last] - buffx[last - 1], 2) + Math.pow(buffy[last] - buffy[last - 1], 2)) > 1) {
					let j = Math.sqrt(Math.pow(buffx[last] - buffx[last - 1], 2) + Math.pow(buffy[last] - buffy[last - 1], 2));
					j = Math.ceil(j);
					for (let i = 1; i <= j; i++) {
						ctx.beginPath();
						ctx.arc(buffx[last - 1] + (buffx[last] - buffx[last - 1]) / j * i, buffy[last - 1] + (buffy[last] - buffy[last - 1]) / j * i, ctx.lineWidth / 2, 0, 2 * Math.PI, true);
						ctx.fill();
						ctx.stroke();

					}
				}
				last++;
			}
		}

		function calc(p0, p1, p2, p3, t) {
			let v0 = (1 - t) * (1 - t) * (1 - t) * p0;
			let v1 = 3 * t * (1 - t) * (1 - t) * p1;
			let v2 = 3 * t * t * (1 - t) * p2;
			let v3 = t * t * t * p3;

			return v0 + v1 + v2 + v3;
		}

		function _draw(e) {

			buffx.push(mouseX);
			buffy.push(mouseY);

			if (pen) {
				ctx.strokeStyle = "rgba(0,0,0,0)";
				ctx.fillStyle = "rgba(" + [r, g, b, alpha] + ")";
				ctx.globalCompositeOperation = 'source-over';
			} else {
				ctx.strokeStyle = "rgba(255,255,255,1)";
				ctx.globalCompositeOperation = 'destination-out';
			}
			if (_last % 3 == 0) {
				let j = Math.sqrt(Math.pow(buffx[last] - buffx[last - 3], 2) + Math.pow(buffy[last] - buffy[last - 3], 2));
				j = Math.ceil(j);
				let div = j;
				let delta_t = 1.0 / div;
				for (let i = 1; i < div; i++) {
					let t0 = i / div;
					let t1 = t0 + delta_t;

					let px0 = calc(buffx[last - 3], buffx[last - 2], buffx[last - 1], buffx[last], t0);
					let py0 = calc(buffy[last - 3], buffy[last - 2], buffy[last - 1], buffy[last], t0);

					let px1 = calc(buffx[last - 3], buffx[last - 2], buffx[last - 1], buffx[last], t1);
					let py1 = calc(buffy[last - 3], buffy[last - 2], buffy[last - 1], buffy[last], t1);

					ctx.beginPath();
					ctx.arc(px0 + (px1 - px0) / j * i, py0 + (py1 - py0) / j * i, ctx.lineWidth / 2, 0, 2 * Math.PI, true);
					ctx.fill();
					ctx.stroke();
				}
			}
			last++;
			_last++;

		}

		layer.addEventListener("pointerdown", function (e) {
			if (!draw_f) {
				draw_f = true;
				esc = 0;
				var rect = e.target.getBoundingClientRect();
				mouseX = e.clientX - rect.left;
				mouseY = e.clientY - rect.top;
				buffx.push(mouseX);
				buffy.push(mouseY);
				last++;
				_last = 1;
				bef_pix = ctx.getImageData(0, 0, canvas.width, canvas.height);
				if (last_undo + 1 == undoImage.length) {
					undoImage.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
				} else {
					undoImage[last_undo + 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
				}
				last_undo++;
				if (!multi) {
					setTimeout("get_pix()", 200);
				}
			}
		});

		layer.addEventListener("pointerup", function (e) {
			if (draw_f) {
				draw_f = false;
				_last = 0;
			}
		});

		let myWorker = new Worker("task.js");
		function get_pix() {
			multi = true;
			if (draw_f || f_reset) {
				f_reset = false;
				af_pix = ctx.getImageData(0, 0, canvas.width, canvas.height);
				let wid = canvas.width;
				let hei = canvas.height;
				let pix = { bef_pix: bef_pix, af_pix: af_pix, wid: wid, hei: hei };
				myWorker.postMessage(pix);
			} else {
				multi = false;
			}
			sum(Number(n_layer.value));
		}


		myWorker.onmessage = function (e) {
			//ピクセルデータ送信
			console.log("a");
			if (e.data)
				pixel_data = e.data.pixel_data;
			socket.emit("pixel data", pixel_data);
			bef_pix = e.data.bef_pix;
			af_pix = e.data.af_pix;
			setTimeout("get_pix()", 200);
		}

		lineWidth.addEventListener("mousemove", function () {
			var lineNum = document.getElementById("lineWidth").value;
			document.getElementById("lineNum").innerHTML = lineNum;
		});

		function sum(num) {
			s_layers[num - 1].getContext('2d').putImageData(layers[num - 1].getContext('2d').getImageData(0, 0, canvas.width, canvas.height), 0, 0);
		}
	</script>

</body>

</html>
