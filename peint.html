<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link href="https://fonts.googleapis.com/css?family=Paytone+One|Source+Sans+Pro:300,700" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="style2.css" rel="stylesheet">
	<title>Document</title>
	<style>
		/* body {
			overflow: hidden;
		} */

		canvas {
			border: solid 1px black;
		}
	</style>

</head>

<body>
	<div class="site">
		<div class="circle"></div>
		<div class="circle"></div>
		<div class="circle"></div>
		<p>ILLAST SPACE</p>
		<div class="circle"></div>
		<div class="circle"></div>
		<div class="circle"></div>
	</div>
	<canvas id="canvas" width="600" height="600"></canvas>
	<div class="colors">
		<input id="R" type="number" min="0" max="255" value="0"></input>
		<input id="G" type="number" min="0" max="255" value="0"></input>
		<input id="B" type="number" min="0" max="255" value="0"></input>
		<button id="reset" type="button">リセット</button>
		<button id="undo" type="button">undo</button>
		<button id="eraser" type="button">消しゴム</button>
	</div>
	<p>線の太さ
		<input type="range" min="1" max="50" value="10" id="lineWidth">
		<span id="lineNum">10</span>
	</p>
	<script>
		let canvas = document.getElementById("canvas");
		let ctx = canvas.getContext("2d");
		let reset = document.getElementById("reset");
		let rgbr = document.getElementById("R");
		let rgbg = document.getElementById("G");
		let rgbb = document.getElementById("B");
		let undo = document.getElementById("undo");
		let eraser = document.getElementById("eraser");

		let mouseX, mouseY, mouseX1, mouseY1;
		let draw_f = false;
		let buffx = [];
		let buffy = [];
		let last = 0;
		let alpha = 0;
		let r = 0;
		let g = 0;
		let b = 0;
		let undoImage;
		let pen = true;

		rgbr.addEventListener("input", function (e) {
			r = Number(e.target.value);
		});

		rgbg.addEventListener("input", function (e) {
			g = Number(e.target.value);
		});

		rgbb.addEventListener("input", function (e) {
			b = Number(e.target.value);
		});

		reset.addEventListener("pointerdown", function (e) {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
		});

		undo.addEventListener("pointerdown", function (e) {

			ctx.putImageData(undoImage, 0, 0);
		});

		eraser.addEventListener("pointerdown", function (e) {
			console.log(e);
			if (pen) {
				e.target.innerHTML = "ペン";
			} else {
				e.target.innerHTML = "消しゴム";
			}
			pen = !pen;
		});


		canvas.addEventListener("pointermove", function (e) {
			var rect = e.target.getBoundingClientRect();
			ctx.lineWidth = document.getElementById("lineWidth").value;
			mouseX = e.clientX - rect.left;
			mouseY = e.clientY - rect.top;
			if (e.pointerType === "pen") {
				alpha = e.pressure;
			} else {
				alpha = 0.1;
			}

			if (draw_f === true) {
				buffx.push(mouseX);
				buffy.push(mouseY);
				mouseX1 = mouseX;
				mouseY1 = mouseY;

				if (pen) {
					// ctx.beginPath();
					// ctx.strokeStyle = "rgba(255,255,255,1)";
					// ctx.globalCompositeOperation = 'destination-out';
					// ctx.moveTo(buffx[last - 1], buffy[last - 1]);
					// ctx.lineTo(buffx[last], buffy[last]);
					// ctx.lineCap = "round";
					// ctx.stroke();
					ctx.beginPath();
					ctx.strokeStyle = "rgba(" + [r, g, b, alpha] + ")";
					ctx.globalCompositeOperation = 'source-over';
				} else {
					ctx.beginPath();
					ctx.strokeStyle = "rgba(255,255,255,1)";
					ctx.globalCompositeOperation = 'destination-out';
				}
				ctx.moveTo(buffx[last - 1], buffy[last - 1]);
				ctx.lineTo(buffx[last], buffy[last]);
				ctx.lineCap = "round";
				ctx.stroke();
				// if (pen) {
				// 	ctx.strokeStyle = "rgba(" + [r, g, b, alpha] + ")";
				// 	ctx.globalCompositeOperation = 'source-over';

				// }
				// ctx.beginPath();
				// ctx.arc(mouseX, mouseY, ctx.lineWidth / 2, 0, 2 * Math.PI, true);
				// ctx.stroke();
				mouseX1 = mouseX;
				mouseY1 = mouseY;
				last++;
			}
		});

		canvas.addEventListener("pointerdown", function (e) {
			if (!draw_f) {
				draw_f = true;
				var rect = e.target.getBoundingClientRect();
				mouseX = e.clientX - rect.left;
				mouseY = e.clientY - rect.top;
				buffx.push(mouseX);
				buffy.push(mouseY);
				last++;
				undoImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
			}
		});

		canvas.addEventListener("pointerup", function (e) {
			if (draw_f) {
				draw_f = false;
			}
		});

		lineWidth.addEventListener("mousemove", function () {
			var lineNum = document.getElementById("lineWidth").value;
			document.getElementById("lineNum").innerHTML = lineNum;
		});
	</script>
	<div id="chat">
		<div id="log"></div>
		<div id="clients"></div>
		<div id="commands"></div>
	</div>

</body>

</html>